package org.homebrew;

public class libkernel {
    private static NativeLibrary lib;
    
    static {
	lib = NativeLibrary.load(0x2001);
    }

    public static long usleep(int usec) {
	return lib.invoke("usleep", usec);
    }

    public static int open(String path, int flags) {
	long buf = NativeMemory.allocateMemory(path.length() + 1);
	NativeMemory.putString(buf, path);
	NativeMemory.putByte(buf + path.length(), (byte)0);
	
	int fd = (int)lib.invoke("open", buf, flags);
	
	NativeMemory.freeMemory(buf);
	return fd;
    }
    
    public static long lseek(int fd, long offset, int whence) {
	return lib.invoke("lseek", fd, offset, whence);
    }

    public static long read(int fd, long buf, int count) {
	return lib.invoke("read", fd, buf, count);
    }
    
    public static long write(int fd, long buf, int count) {
	return lib.invoke("write", fd, buf, count);
    }

    public static int close(int fd) {
	return (int)lib.invoke("close", fd);
    }

    public static int getpid() {
	return (int)lib.invoke("getpid");
    }

    public static int kqueue() {
	return (int)lib.invoke("kqueue");
    }

    public static int kevent(int kq, long changelist, int nchanges,
			     long eventlist, int nevents, long timeout) {
	return (int)lib.invoke("kevent", kq, changelist, nchanges, eventlist,
			       nevents, timeout);
    }

    public static long memset(long dest, int c, long len) {
	return lib.invoke("memset", dest, c, len);
    }

    public static int pipe(long fds) {
	return (int)lib.invoke("pipe2", fds);
    }
    
    public static int socket(int domain, int type, int protocol) {
	return (int)lib.invoke("socket", domain, type, protocol);
    }

    public static int getsockopt(int sockfd, int level, int optname, long optval,
				 long optlen) {
	 return (int)lib.invoke("getsockopt", sockfd, level, optname, optval, optlen);
    }

    public static int setsockopt(int sockfd, int level, int optname, long optval,
				 int optlen) {
	return (int)lib.invoke("setsockopt", sockfd, level, optname, optval, optlen);
    }

    public static int cpuset_setaffinity(int level, int which, long id, int setsize, long mask) {
	return (int)lib.invoke("cpuset_setaffinity", level, which, id, setsize, mask);
    }

    public static int rtprio_thread(int function, int lwpid, long prio) {
	return (int)lib.invoke("rtprio_thread", function, lwpid, prio);
    }
    
    public static int sendNotificationRequest(String msg) {
	long size = 0xc30;
	long addr = NativeMemory.allocateMemory(size);

	NativeMemory.setMemory(addr, size, (byte)0);
	NativeMemory.putInt(addr + 0x10, -1);
	NativeMemory.putString(addr + 0x2d, msg);

	long res = lib.invoke("sceKernelSendNotificationRequest", 0, addr, size, 0);

	NativeMemory.freeMemory(addr);

	return (int)res;
    }
}
